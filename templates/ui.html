<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Simple Config Server UI</title>
<!-- Tabler (Bootstrap 5 based) -->
<link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" rel="stylesheet"/>
<style>

  /* Minimal layout tweaks */
  .sticky-sidebar {
    position: sticky;
    top: 1rem;
    z-index: 1020;
    max-height: calc(100vh - 2rem);
    overflow: auto;
  }

  #env-select { width: 100%; }

  #selected-env-table td {
    padding-top: .75rem;
    padding-bottom: .75rem;
    vertical-align: top;
  }

  #selected-env-table td:nth-child(2) {
    white-space: nowrap;
  }

  /* Make text selection visible in dark inputs (some themes make it too subtle) */
  ::selection {
    background: rgba(var(--tblr-primary-rgb, var(--bs-primary-rgb)), .35);
    color: var(--bs-body-color);
  }
  ::-moz-selection {
    background: rgba(var(--tblr-primary-rgb, var(--bs-primary-rgb)), .35);
    color: var(--bs-body-color);
  }
  input::selection, textarea::selection, .form-control::selection {
    background: rgba(var(--tblr-primary-rgb, var(--bs-primary-rgb)), .45);
    color: var(--bs-body-color);
  }
  input::-moz-selection, textarea::-moz-selection, .form-control::-moz-selection {
    background: rgba(var(--tblr-primary-rgb, var(--bs-primary-rgb)), .45);
    color: var(--bs-body-color);
  }

</style>
</head>
<body>
<div class="page" id="root">
<!-- HERO -->
<div class="container-xl mt-3">
<div class="card">
<div class="card-body">
<div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
<div>
<h2 class="mb-1">
<i class="ti ti-settings me-2"></i>
                Simple Config Server
              </h2>
<div class="text-muted">
                Multi-environment configuration server compatible with Spring Cloud Config,
                with template expansion over environment variables and Git-backed assets.
              </div>
</div>
<div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
<span class="badge bg-azure-lt">envs: <span id="hero-env-count">0</span></span>
<span class="badge bg-indigo-lt">auth: <span id="hero-auth-mode">?</span></span>
<span class="badge bg-secondary-lt">
                base_sha: <span class="font-monospace" id="hero-base-sha-short">-</span>
</span>
<button class="btn btn-sm btn-icon" id="btnCopyHeroSha" title="Copy full base_sha" type="button">
<i class="ti ti-copy"></i>
</button>
<span class="badge bg-secondary-lt">
                reloaded: <span class="font-monospace" id="hero-reloaded-at">-</span>
</span>
<label class="form-check form-switch m-0 ms-2">
<input class="form-check-input" id="theme-toggle" type="checkbox"/>
<span class="form-check-label">Theme</span>
</label>
</div>
</div>
</div>
</div>
</div>
<!-- MAIN -->
<div class="page-wrapper">
<div class="page-body pt-0 mt-0">
<div class="container-xl mt-3">
<div class="row g-3" id="main-content">
<!-- LEFT -->
<div class="col-12 col-xl-3" id="left-column">
<div class="d-flex flex-column gap-3 sticky-sidebar">
<div class="card">
<div class="card-header">
<h3 class="card-title">Environment</h3>
</div>
<div class="card-body">
<select aria-label="Select environment" class="form-select form-select-lg" id="env-select">
<option selected="" value="">Loading…</option>
</select>
</div>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title">Selected environment</h3>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-sm mb-0" id="selected-env-table">
<tbody>
<tr>
<td class="text-muted w-1"><i class="ti ti-id"></i></td>
<td class="text-muted">Name</td>
<td class="font-monospace" id="env-name">-</td>
</tr>
<tr>
<td class="text-muted w-1"><i class="ti ti-link"></i></td>
<td class="text-muted">Repo</td>
<td class="font-monospace" id="env-repo">-</td>
</tr>
<tr>
<td class="text-muted w-1"><i class="ti ti-git-branch"></i></td>
<td class="text-muted">Branch</td>
<td class="font-monospace" id="env-branch">-</td>
</tr>
<tr>
<td class="text-muted w-1"><i class="ti ti-folder"></i></td>
<td class="text-muted">Subpath</td>
<td class="font-monospace" id="env-subpath">-</td>
</tr>
<tr>
<td class="text-muted w-1"><i class="ti ti-terminal-2"></i></td>
<td class="text-muted">Workdir</td>
<td class="font-monospace" id="env-workdir">-</td>
</tr>
<tr>
<td class="text-muted w-1"><i class="ti ti-git-commit"></i></td>
<td class="text-muted">Commit</td>
<td class="font-monospace" id="env-last-commit">-</td>
</tr>
<tr>
<td class="text-muted w-1"><i class="ti ti-calendar-time"></i></td>
<td class="text-muted">Commit date</td>
<td class="font-monospace" id="env-last-commit-date">-</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- RIGHT -->
<div class="col-12 col-xl-9" id="right-column">
<div class="row g-3">
<div class="col-12">
<div class="card">
<div class="card-header">
<h3 class="card-title">Environment variables (JSON)</h3>
<div class="card-actions">
<button class="btn btn-sm btn-icon" onclick="copyPre('env-json')" title="Copy JSON" type="button">
<i class="ti ti-copy"></i>
</button>
</div>
</div>
<div class="card-body">
<pre class="m-0 p-3 border rounded bg-body-tertiary font-monospace overflow-auto text-body" id="env-json" style="max-height: 260px;">Select environment…</pre>
</div>
</div>
</div>
<div class="col-12">
<div class="card">
<div class="card-header">
<h3 class="card-title">Environment variables as shell exports</h3>
<div class="card-actions">
<button class="btn btn-sm btn-icon" onclick="copyPre('env-export')" title="Copy exports" type="button">
<i class="ti ti-copy"></i>
</button>
</div>
</div>
<div class="card-body">
<pre class="m-0 p-3 border rounded bg-body-tertiary font-monospace overflow-auto text-body" id="env-export" style="max-height: 240px;">Select environment…</pre>
</div>
</div>
</div>
<div class="col-12">
<div class="card">
<div class="card-header">
<h3 class="card-title">Spring config JSON preview</h3>
<div class="card-actions">
<button class="btn btn-sm btn-icon" onclick="copyPre('spring-preview')" title="Copy Spring JSON" type="button">
<i class="ti ti-copy"></i>
</button>
</div>
</div>
<div class="card-body">
<div class="text-muted mb-3">
                        Simulates a Spring Cloud Config client call for the currently selected environment.
                        Fill in <code>application</code>, <code>profile</code> and optional <code>label</code>.
                      </div>
<form id="spring-form">
<div class="row g-2">
<div class="col-12 col-md-4">
<label class="form-label">Application</label>
<input class="form-control font-monospace" id="spring-app" placeholder="tsm-deco" type="text" value="tsm-deco"/>
</div>
<div class="col-12 col-md-4">
<label class="form-label">Profile</label>
<input class="form-control font-monospace" id="spring-profile" placeholder="default" type="text" value="default"/>
</div>
<div class="col-12 col-md-4">
<label class="form-label">Label (optional)</label>
<input class="form-control font-monospace" id="spring-label" placeholder="main / release / empty" type="text"/>
</div>
</div>
<div class="mt-3 d-flex align-items-center gap-2 flex-wrap">
<button class="btn btn-primary" type="submit">Load preview</button>
<span class="text-muted small font-monospace" id="spring-request-path"></span>
</div>
</form>
<div class="mt-3">
<pre class="m-0 p-3 border rounded bg-body-tertiary font-monospace overflow-auto text-body" id="spring-preview" style="max-height: 260px;">Select environment and load preview…</pre>
</div>
</div>
</div>
</div>
<div class="col-12">
<div class="card">
<div class="card-header">
<h3 class="card-title">Files &amp; templated preview (git repo)</h3>
<div class="card-actions">
<button class="btn btn-sm btn-icon" onclick="copyPre('file-preview')" title="Copy preview" type="button">
<i class="ti ti-copy"></i>
</button>
</div>
</div>
<div class="card-body">
<div class="row g-3">
<div class="col-12 col-md-4">
<div class="text-muted mb-2">Files</div>
<ul class="list-group list-group-flush border rounded overflow-auto" id="files-list" style="max-height: 320px;">
<li class="list-group-item text-muted">No environment selected.</li>
</ul>
</div>
<div class="col-12 col-md-8">
<div class="text-muted mb-2">Preview (templated text)</div>
<pre class="m-0 p-3 border rounded bg-body-tertiary font-monospace overflow-auto text-body" id="file-preview" style="max-height: 320px;">Select a file to preview…</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Tabler JS (optional, but harmless) -->
<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>
<script>

    // Filled in by the server: UiMeta { base_path, environments[] }
    const META = __META_JSON__;

    function apiBase() {
      if (!META || !META.base_path) return "";
      return META.base_path === "/" ? "" : META.base_path;
    }

    function byEnvName(name) {
      return META.environments.find((e) => e.name === name);
    }

    let currentEnv =
      META && META.environments && META.environments.length > 0
        ? META.environments[0].name
        : null;

    function renderEnvList() {
      // Legacy name kept: we no longer render a clickable list, only the <select>.
      renderEnvSelect();
    }


    function renderEnvSelect() {
      const select = document.getElementById("env-select");
      if (!select) return;

      select.innerHTML = "";
      META.environments.forEach((env) => {
        const opt = document.createElement("option");
        opt.value = env.name;
        opt.textContent = env.name;
        select.appendChild(opt);
      });

      // Keep selection in sync
      select.value = currentEnv || (META.environments[0] && META.environments[0].name) || "";

      // Set handler once
      if (!select.dataset.bound) {
        select.addEventListener("change", () => {
          if (!select.value) return;
          currentEnv = select.value;
          renderEnvList();
          renderEnvDetails();
          if (META.auth_enabled) {
            loadEnvPanels();
          }
        });
        select.dataset.bound = "1";
      }
    }

    function renderEnvDetails() {
      const env = byEnvName(currentEnv);
      if (!env) {
        return;
      }

      document.getElementById("env-name").textContent = env.name;
      document.getElementById("env-repo").textContent = env.repo_url;
      document.getElementById("env-branch").textContent = env.branch;
      document.getElementById("env-subpath").textContent = env.subpath || "";
      document.getElementById("env-workdir").textContent = env.workdir;
      document.getElementById("env-last-commit").textContent =
        env.last_commit || "";
      document.getElementById("env-last-commit-date").textContent =
        env.last_commit_date || "";


      updateHeroMeta(env);
    }


    function shortSha(sha) {
      if (!sha) return "-";
      const s = String(sha);
      return s.length > 12 ? s.slice(0, 12) : s;
    }

    function formatNowLocal() {
      const d = new Date();
      const pad = (n, len = 2) => String(n).padStart(len, "0");
      return (
        d.getFullYear() +
        "-" +
        pad(d.getMonth() + 1) +
        "-" +
        pad(d.getDate()) +
        " " +
        pad(d.getHours()) +
        ":" +
        pad(d.getMinutes()) +
        ":" +
        pad(d.getSeconds()) +
        "." +
        pad(d.getMilliseconds(), 3)
      );
    }

    let lastHeroShaFull = "";

    function updateHeroMeta(env) {
      const shaFull = env && env.last_commit ? String(env.last_commit) : "";
      lastHeroShaFull = shaFull;

      const shaEl = document.getElementById("hero-base-sha-short");
      if (shaEl) {
        shaEl.textContent = shaFull ? shortSha(shaFull) : "-";
      }

      const relEl = document.getElementById("hero-reloaded-at");
      if (relEl) {
        relEl.textContent = formatNowLocal();
      }
    }

    async function loadEnvPanels() {
      const env = byEnvName(currentEnv);
      if (!env) return;

      const base = apiBase();
      const envName = encodeURIComponent(env.name);

      // /{env}/env
      fetch(`${base}/${envName}/env`)
        .then((r) => (r.ok ? r.json() : Promise.reject(r)))
        .then((data) => {
          document.getElementById("env-json").textContent = JSON.stringify(
            data,
            null,
            2
          );
        })
        .catch(() => {
          document.getElementById("env-json").textContent =
            "Failed to load environment variables.";
        });

      // /{env}/env/export
      fetch(`${base}/${envName}/env/export`)
        .then((r) => (r.ok ? r.text() : Promise.reject(r)))
        .then((text) => {
          document.getElementById("env-export").textContent = text;
        })
        .catch(() => {
          document.getElementById("env-export").textContent =
            "Failed to load export view.";
        });

      // /{env}/assets
      fetch(`${base}/${envName}/assets`)
        .then((r) => (r.ok ? r.json() : Promise.reject(r)))
        .then((data) => {
          const files = (data && data.files) || [];
          const listEl = document.getElementById("files-list");
          listEl.innerHTML = "";
          if (files.length === 0) {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent = "No files found in this environment.";
            listEl.appendChild(li);
            return;
          }

          files.forEach((f) => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex align-items-center";

            const icon = document.createElement("i");
            icon.className = "ti ti-file-text me-2 text-muted";
            icon.title = "Config file";
            li.appendChild(icon);

            const a = document.createElement("a");
            a.className = "link-primary text-decoration-none";
            a.textContent = f;
            a.href = "#";
            a.addEventListener("click", (ev) => { ev.preventDefault(); previewFile(env, f); });
            li.appendChild(a);

            listEl.appendChild(li);
          });
        })
        .catch(() => {
          document.getElementById("files-list").innerHTML =
            "<li class=\"list-group-item\">Failed to list files.</li>";
        });
    }

    // Encode a *path* for use inside a URL path segment, but keep '/' as separator.
    // (encodeURIComponent would turn 'src/Makefile' into 'src%2FMakefile', which breaks our backend routing.)
    function encodePathPreserveSlashes(p) {
      const s = String(p || "").replace(/^\/+/, "");
      return s
        .split("/")
        .map((seg) => encodeURIComponent(seg))
        .join("/");
    }

    function previewFile(env, relPath) {
      const base = apiBase();
      const envName = encodeURIComponent(env.name);
      const path = encodePathPreserveSlashes(relPath);

      // Uses the REST-ish assets endpoint: /{env}/assets/{path}
      const url = `${base}/${envName}/assets/${path}`;

      fetch(url)
        .then((r) => r.text())
        .then((text) => {
          document.getElementById("file-preview").textContent = text;
        })
        .catch(() => {
          document.getElementById("file-preview").textContent =
            "Failed to load file.";
        });
    }


    function setupSpringPreview() {
      const form = document.getElementById("spring-form");
      const previewEl = document.getElementById("spring-preview");
      const pathEl = document.getElementById("spring-request-path");
      if (!form || !previewEl || !pathEl) {
        return;
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();

        const env = byEnvName(currentEnv);
        if (!env) {
          previewEl.textContent = "No environment selected.";
          return;
        }

        const appInput = document.getElementById("spring-app");
        const profileInput = document.getElementById("spring-profile");
        const labelInput = document.getElementById("spring-label");

        const app = (appInput.value || "").trim();
        const profile = (profileInput.value || "").trim() || "default";
        const label = (labelInput.value || "").trim();

        if (!app || !profile) {
          previewEl.textContent = "Application and profile are required.";
          return;
        }

        const base = apiBase();
        const envName = encodeURIComponent(env.name);
        let path = `${base}/${envName}/${encodeURIComponent(app)}/${encodeURIComponent(profile)}`;
        if (label) {
          path += `/${encodeURIComponent(label)}`;
        }

        pathEl.textContent = "GET " + path;
        previewEl.textContent = "Loading...";

        fetch(path, {
          headers: {
            Accept: "application/json",
          },
        })
          .then((r) => {
            if (!r.ok) {
              return r.text().then((t) => {
                throw new Error(
                  "HTTP " + r.status + ": " + (t || r.statusText || "")
                );
              });
            }
            return r.json();
          })
          .then((data) => {
            try {
              previewEl.textContent = JSON.stringify(data, null, 2);
            } catch (e) {
              previewEl.textContent = "Received non-JSON response.";
            }
          })
          .catch((err) => {
            previewEl.textContent = "Error: " + err.message;
          });
      });
    }


    // univerzální copy helper pro <pre> bloky
    function copyPre(id) {
      const pre = document.getElementById(id);
      if (!pre) return;
      const text = pre.textContent || "";

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      } else {
        // fallback pro starší browsery
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand("copy");
        } catch (e) {}
        document.body.removeChild(ta);
      }
    }


    function copyText(text) {
      const t = String(text || "");
      if (!t) return;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(t).catch(() => {});
      } else {
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand("copy");
        } catch (e) {}
        document.body.removeChild(ta);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (!META || !META.environments || META.environments.length === 0) {
        document.getElementById("main-content").innerHTML =
          "<p>No environments configured in config.yaml.</p>";
        return;
      }

      renderEnvList();
      renderEnvDetails();

      if (META.auth_enabled) {
        // full mode: env JSON, exports, files, preview
        loadEnvPanels();
        setupSpringPreview();
      } else {
        // read-only UI: only environment list & metadata
        const rightCol = document.getElementById("right-column");
        if (rightCol) {
          rightCol.style.display = "none";
        }
        const leftCol = document.getElementById("left-column");
        if (leftCol) {
          leftCol.classList.remove("col-xl-3");
          leftCol.classList.add("col-xl-12");
        }
      }

        // hero env count
        const envCountEl = document.getElementById("hero-env-count");
        if (envCountEl && META && META.environments) {
          envCountEl.textContent = META.environments.length.toString();
        }

        const authModeEl = document.getElementById("hero-auth-mode");
        if (authModeEl) {
          if (!META.auth_enabled) {
            authModeEl.textContent = "Off";
          } else if (META.basic_auth_enabled && META.client_auth_enabled) {
            authModeEl.textContent = "Basic + ClientId";
          } else if (META.basic_auth_enabled) {
            authModeEl.textContent = "Basic";
          } else if (META.client_auth_enabled) {
            authModeEl.textContent = "ClientId";
          } else {
            authModeEl.textContent = "Custom";
          }

        const copyBtn = document.getElementById("btnCopyHeroSha");
        if (copyBtn) {
          copyBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            copyText(lastHeroShaFull || "");
          });
        }

        }

    });

  
  </script>
<script>
    // Simple theme toggle (Bootstrap 5.3 / Tabler)
    (function () {
      const key = "simple-config-ui-theme";
      const root = document.documentElement;
      const toggle = document.getElementById("theme-toggle");

      function setTheme(t) {
        root.setAttribute("data-bs-theme", t);
      }

      const saved = localStorage.getItem(key);
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      const initial = saved || (prefersDark ? "dark" : "light");
      setTheme(initial);

      if (toggle) {
        toggle.checked = initial === "dark";
        toggle.addEventListener("change", () => {
          const next = toggle.checked ? "dark" : "light";
          setTheme(next);
          localStorage.setItem(key, next);
        });
      }
    })();
  </script>
</body>
</html>
